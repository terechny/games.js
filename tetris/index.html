<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <title>Color Romb | Java Script Games</title>
</head>
<body>
    <div class="container"> 
        <div class="p-2 ">
            <h3>Java Script Games</h3>
        </div>  
        <hr>
        <div class="row">
            <div class="col-sm-4">           
                <div class="d-flex justify-content-between">
                    <div> <h1> Tetris </h1> </div>
                    <div> <h4 id="score">0</h4> </div> 
                </div>                   
                <div class="mt-4" id="window" ></div>
            </div>
        </div>
   </div>
    <style>

       #window{
        background-color: #F3F3F3;
        width: 400px;
        height: 500px;
       }

       .romb{
        width: 20px;
        height: 20px;
        color:white;
        position: absolute;
        outline: 1px white solid;
       }

       .blue_ricky{
            background-color: blue;           
       }

       .smashboy{
            background-color: #F4CA16;
       }

       .herro{
           background-color: aquamarine;
       }

    </style>

    <script>


        class Elements
        {

            TetrisElements

            constructor(elements){

                TetrisElements = elements

            }


        }
      
        class Tetris
        {

            elements
            activeClassName
            wind
            randomIndex
            windStyle
            tochArray
            winWidth
            fullRowCount
            passedClasses = {}
            scorePoint = 0
            active

            constructor(elements){

                this.elements = elements
                this.wind = document.getElementById("window")
                this.windStyle = window.getComputedStyle(this.wind)
                this.winWidth = Number( this.windStyle.width.slice(0,-2)) 
                this.fullRowCount = this.winWidth/20
            }

            move(e){
                
                this.active = document.getElementsByClassName(this.activeClassName )
                
                if(e.key == 'Enter'){ this.create() }
                if(e.key == 'Shift'){ this.flip() }

               
                for (var i = 0; i < this.active.length; i++) {
                    
                    let data = this.getCoortinateKey(this.active[i])

                    switch(e.key){

                        case 'ArrowDown':                    
                            this.active[i].style.marginTop = data.top + 20 + "px"
                            break

                        case "ArrowRight":                      
                            this.active[i].style.marginLeft = data.left + 20 + "px"
                            break

                        case "ArrowLeft":
                            this.active[i].style.marginLeft = data.left - 20 + "px"                   
                            break
                    }                
                }                

                this.coordidate()
 
            }

            coordidate(){

                let winHeight = Number( this.windStyle.height.slice(0,-2))              
                let touchStatus = false

                this.countRowsForDelete()

                for (var i = 0; i < this.active.length; i++) {

                    let data = this.getCoortinateKey(this.active[i])

                    if(this.tochArray.hasOwnProperty( data.key ) ){

                        touchStatus = true;                    
                    } 

                    if( winHeight ==  data.top + 20 ){

                        touchStatus = true;                       
                    }             
                }

                touchStatus ? this.addTouhStatus() : null ;

            } 

            addTouhStatus(){

                for (var i = 0; i < this.active.length; i++) {

                    this.active[i].classList.add('touch')
                }  

                this.create()
            }
            
            create(position=0){

                this.randomIndex = Math.floor(Math.random() * 3)
               
                let element = this.elements[this.randomIndex]
                let clases = element.classes
                let styles = element.stiles[position]    
                
                if( ! this.passedClasses.hasOwnProperty(clases[1]) ){

                         this.passedClasses[clases[1]] = 0;
                    } 

                this.passedClasses[clases[1]]++

                let classElLen = this.passedClasses[clases[1]]

                this.activeClassName = element.classes[1] + "-" + classElLen

                const wind = this.wind

                styles.forEach(function(items, is, arrs) {

                    let divEdement = document.createElement("div")

                    clases.forEach(function(classItem, ic, classArr){

                        divEdement.classList.add(classItem)

                        if(ic == 1){

                            let classGroup = classItem + "-" + classElLen
                            
                            let elClass = classGroup + "-" + ++is

                            divEdement.classList.add(classGroup)
                            divEdement.classList.add(elClass)
                            divEdement.innerText = is
                            divEdement.dataset.position = position
                        } 
                                            
                    })
                                                    
                    items.forEach(function(item, i, arr) {

                        if( parseInt(item) > 0 ) {

                            if( i == 0 ){
                                divEdement.style.marginTop = item + "px" 
                            }
                            if( i == 1 ){}
                            if( i == 2 ){}  
                            if( i == 3 ){                            
                                divEdement.style.marginLeft =  item + "px"
                            }                                                                                            
                        }               
                    })
                    
                    wind.appendChild(divEdement)
                }) 
            }

            flip(){

                if( this.activeClassName !==  'smashboy-0' ){

                    let nextPositionIndex = parseInt(this.active[0].dataset.position ) + 1 
                    
                    if( nextPositionIndex > 4 ){ nextPositionIndex = 1 }

                    let nextPosition = this.elements[this.randomIndex].stiles[nextPositionIndex]

                    for (var i = 0; i < this.active.length; i++) {

                        let el = window.getComputedStyle(this.active[i])
                        let left = parseInt(el.marginLeft)
                        let top =  parseInt(el.marginTop)

                        this.active[i].style.marginTop = top + nextPosition[i][0] + "px"
                        this.active[i].style.marginLeft = left + nextPosition[i][3] + "px"  
                        this.active[i].dataset.position = nextPositionIndex            
                    }                    
                }
            }

            deleteRow(elements, row){
             
                let deletRows = [];

                for (var i = 0; i < elements.length; i++) {

                    let elnTop =  Number( elements[i].style.marginTop.slice(0,-2) )

                    if(  Number(row) == elnTop ){
                        
                        deletRows[i] = elements[i];
                    }
                }

                for( let el in deletRows){

                    deletRows[el].remove()

                    this.scorePoint++
                }   
                
                this.scoreUpdate()
            }

            scoreUpdate(){

                let score = document.getElementById('score').textContent = this.scorePoint
            }

            moveDownRows(elements, deletedRowsCount){

                if(deletedRowsCount > 0){   

                    for( let i = 1; i <= deletedRowsCount; i++  ){

                        this.moveDownRow(elements)
                    }
                }
            }

            moveDownRow(elements){

                for (var i = 0; i < elements.length; i++) {

                    let el = window.getComputedStyle(elements[i])
                    let top =  parseInt(el.marginTop)
                    elements[i].style.marginTop = top + 20 + "px"
                }
            }

            countRowsForDelete(){

                let touchElements = document.getElementsByClassName('touch') 
                let rowCount = {}            
                this.tochArray = {}
                
                for (var i = 0; i < touchElements.length; i++) {

                    let elnTop =  Number( touchElements[i].style.marginTop.slice(0,-2) )
                    let elnLeft =  Number( touchElements[i].style.marginLeft.slice(0,-2) )
                    let key = elnTop +'-'+ elnLeft 

                    this.tochArray[key] = key;

                    if( ! rowCount.hasOwnProperty(elnTop) ){
                        rowCount[elnTop] = 0;
                    } 
                    rowCount[elnTop]++                    
                }
           
                let deletedRowsCount = 0;

                for(let row in rowCount){

                    if( this.fullRowCount == rowCount[row] ){

                        this.deleteRow(touchElements, row)
                        deletedRowsCount++
                    }
                }

                this.moveDownRows(touchElements, deletedRowsCount)           
            }

            getCoortinateKey(element){

                let el = window.getComputedStyle(element)

                let left = parseInt(el.marginLeft)
                let top =  parseInt(el.marginTop)
                
                let distToTop = parseInt( top ) + 20

                let key = distToTop +'-'+ parseInt(left)

                return { 
                        'left': left, 
                        'top': top, 
                        'key': key 
                       }              
            }
        
        }
        
        const TetrisElements = [

            {                   
                classes: ["romb", "blue_ricky"],
                stiles: [  
                    [
                        [0, 0, 0, 20],
                        [20, 0, 0, 20],
                        [40, 0, 0, 20],
                        [40, 0, 0, 0]  
                    ],
                    [
                        [20, 0, 0, 20],
                        [0, 0, 0, 0],
                        [-20, 0, 0, -20],
                        [-40, 0, 0, 0]  
                    ],
                    [
                        [20, 0, 0, -20],
                        [0, 0, 0, 0],
                        [-20, 0, 0, 20],
                        [0, 0, 0, 40]  
                    ],
                    [
                        [-20, 0, 0, -20],
                        [0, 0, 0,0],
                        [20, 0, 0, 20],
                        [40, 0, 0, 0]  
                    ],
                    [
                        [-20, 0, 0, 20],
                        [0, 0, 0,0],
                        [20, 0, 0, -20],
                        [0, 0, 0, -40]  
                    ]                                                                                                                    
                ]                                
            },
            {                                       
                classes: ["romb", "smashboy"],
                stiles: [ 
                    [                   
                        [0, 0, 0, 0],
                        [0, 0, 0, 20],
                        [20, 0, 0, 20],
                        [20, 0, 0, 0]   
                    ]            
                ]                                
            },    
            {                                        
                classes: ["romb", "herro"],
                stiles: [  
                    [                                      
                        [0, 0, 0, 0],
                        [20, 0, 0, 0],
                        [40, 0, 0, 0],
                        [60, 0, 0, 0]  
                    ],
                    [
                        [20, 0, 0, 20],
                        [0, 0, 0, 0],
                        [-20, 0, 0, -20],
                        [-40, 0, 0, -40]  
                    ],
                    [
                        [20, 0, 0, -20],
                        [0, 0, 0, 0],
                        [-20, 0, 0, 20],
                        [-40, 0, 0, 40]  
                    ],
                    [
                        [-20, 0, 0, -20],
                        [0, 0, 0,0],
                        [20, 0, 0, 20],
                        [40, 0, 0, 40]  
                    ],
                    [
                        [-20, 0, 0, 20],
                        [0, 0, 0,0],
                        [20, 0, 0, -20],
                        [40, 0, 0, -40]  
                    ]                     
                ]                                
            } 
        
        ]  

        const tetris = new Tetris(TetrisElements)

        addEventListener('keydown', event => { tetris.move(event) } )
      
/*
    J - Blue Ricky / blue_ricky, 
    L - Orange Ricky, 
    S - Cleveland Z,    
    Z - Rhode Island Z 
    Т - Teewee
    Квадрат - Smashboy
    длинный - Hero   
*/


    </script>
</body>
</html>